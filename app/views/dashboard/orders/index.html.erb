<div class="container py-5" style="margin-top: 20dvh;">
  <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
    <div class="card-body p-4">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
        <div>
          <span class="badge rounded-pill px-3 py-2 mb-2" style="background: #f1f5f9; color: #475569; font-weight: 600;">Panou administrare</span>
          <h1 class="h3 mb-1" style="color: #1e293b; font-weight: 600;">Comenzi online</h1>
          <p class="text-muted small mb-0">Monitorizează fluxul de comenzi, modifică statusuri și gestionează rapid solicitările clienților.</p>
        </div>
        <div class="d-flex flex-wrap gap-3 text-end">
          <div>
            <p class="mb-1 text-muted small">Total venituri</p>
            <p class="h4 mb-0"><%= @revenue_total.format %></p>
          </div>
          <div class="border-start ps-3">
            <p class="mb-1 text-muted small">Venituri luna curentă</p>
            <p class="h5 mb-0"><%= @revenue_this_month.format %></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
    <div class="card-body p-3">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <%= link_to dashboard_orders_path, class: "btn btn-sm", style: "#{@status_filter.blank? ? 'background: #1e293b; color: white;' : 'background: white; color: #64748b; border: 1px solid #e5e7eb;'} border-radius: 6px;" do %>
          Toate (<%= @status_counts.values.sum %>)
        <% end %>
        <% Cart::STATUSES.values.each do |status_value| %>
          <% label = Cart::STATUS_LABELS[status_value] || status_value.to_s.titleize %>
          <% count = @status_counts[status_value] || 0 %>
          <% active = (status_value == @status_filter) %>
          <%= link_to "#{label} (#{count})", dashboard_orders_path(status: status_value.presence, query: @query), class: "btn btn-sm #{active ? 'btn-primary' : 'btn-outline-secondary'}" %>
        <% end %>
        <div class="vr mx-2 d-none d-md-block"></div>
        <div class="d-flex flex-wrap gap-2">
          <%= link_to 'Azi', dashboard_orders_path(request.query_parameters.merge(delivery: 'today')), class: "btn btn-sm #{'btn-outline-primary' if @delivery_filter == 'today'} btn-outline-secondary" %>
          <%= link_to 'Mâine', dashboard_orders_path(request.query_parameters.merge(delivery: 'tomorrow')), class: "btn btn-sm #{'btn-outline-primary' if @delivery_filter == 'tomorrow'} btn-outline-secondary" %>
          <%= link_to 'Următoarele 7 zile', dashboard_orders_path(request.query_parameters.merge(delivery: 'next_7_days')), class: "btn btn-sm #{'btn-outline-primary' if @delivery_filter == 'next_7_days'} btn-outline-secondary" %>
          <%= link_to 'Toate viitoare', dashboard_orders_path(request.query_parameters.merge(delivery: 'future')), class: "btn btn-sm #{'btn-outline-primary' if @delivery_filter == 'future'} btn-outline-secondary" %>
          <%= link_to 'În trecut', dashboard_orders_path(request.query_parameters.merge(delivery: 'past')), class: "btn btn-sm #{'btn-outline-primary' if @delivery_filter == 'past'} btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
    <div class="card-body">
      <%= form_with url: dashboard_orders_path, method: :get, local: true, class: 'row g-3 align-items-end' do |f| %>
        <div class="col-md-5">
          <%= f.label :query, 'Caută după client, email, telefon, adresă sau sesiune Stripe', class: 'form-label small text-muted' %>
          <%= f.text_field :query, value: @query, class: 'form-control', placeholder: 'Ex.: popescu, 07xx, stripe_session_id' %>
        </div>
        <div class="col-md-3">
          <%= f.label :status, 'Status', class: 'form-label small text-muted' %>
          <%= f.select :status, options_for_select([['Toate', '']] + Cart::STATUSES.values.map { |value| [Cart::STATUS_LABELS[value] || value.to_s.titleize, value] }, @status_filter), {}, class: 'form-select' %>
        </div>
        <div class="col-md-2">
          <%= f.label :order, 'Sortare', class: 'form-label small text-muted' %>
          <%= f.select :order, options_for_select([['Cele mai noi', 'newest'], ['Cele mai vechi', 'oldest']], params[:order]), {}, class: 'form-select' %>
        </div>
        <div class="col-md-2">
          <div class="form-check mt-4">
            <%= f.check_box :only_open, { class: 'form-check-input', checked: @only_open }, '1', '0' %>
            <%= f.label :only_open, 'Doar comenzi deschise', class: 'form-check-label small' %>
          </div>
        </div>
        <div class="col-md-2 d-flex gap-2">
          <%= f.submit 'Aplică filtre', class: 'btn w-100', style: 'background: #1e293b; color: white; border: none; border-radius: 6px;' %>
          <%= link_to 'Reset', dashboard_orders_path, class: 'btn', style: 'background: white; color: #64748b; border: 1px solid #e5e7eb; border-radius: 6px;' %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header py-3" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h3 class="h6 mb-0" style="color: #1e293b; font-weight: 600;">Livrări rapide</h3>
          <p class="text-muted small mb-0">Sumar pentru astăzi, mâine și următoarele zile.</p>
        </div>
        <div class="card-body">
          <h4 class="h6 text-uppercase text-muted small mb-2">Astăzi</h4>
          <% if @today_orders.any? %>
            <ul class="list-group list-group-flush mb-3">
              <% @today_orders.limit(5).each do |order| %>
                <li class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
                  <div>
                    <strong>#<%= order.id %></strong>
                    <div class="text-muted small"><%= order.customer_name %></div>
                  </div>
                  <div class="text-end small text-muted">
                    <div><%= format_order_total(order) %></div>
                    <%= link_to 'Detalii', dashboard_order_path(order), class: 'small d-block' %>
                  </div>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="small text-muted mb-3">Nicio livrare programată azi.</p>
          <% end %>

          <h4 class="h6 text-uppercase text-muted small mb-2">Mâine</h4>
          <% if @tomorrow_orders.any? %>
            <ul class="list-group list-group-flush mb-3">
              <% @tomorrow_orders.limit(5).each do |order| %>
                <li class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
                  <div>
                    <strong>#<%= order.id %></strong>
                    <div class="text-muted small"><%= order.customer_name %></div>
                  </div>
                  <div class="text-end small text-muted">
                    <div><%= format_order_total(order) %></div>
                    <%= link_to 'Detalii', dashboard_order_path(order), class: 'small d-block' %>
                  </div>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="small text-muted mb-3">Nicio livrare programată mâine.</p>
          <% end %>

          <h4 class="h6 text-uppercase text-muted small mb-2">Următoarele 7 zile</h4>
          <% if @next_week_orders.any? %>
            <p class="small mb-0 text-muted">
              <strong><%= @next_week_orders.count %></strong> comenzi programate în următoarele zile.
            </p>
          <% else %>
            <p class="small text-muted mb-0">Nu există comenzi programate în următoarele zile.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Comenzi</h2>
          <span class="text-muted small">Pagina <%= @pagy.page %> din <%= @pagy.pages %></span>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0 dashboard-orders-table">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Client</th>
                <th>Livrare</th>
                <th>Status</th>
                <th>Total</th>
                <th class="text-end">Acțiuni</th>
              </tr>
            </thead>
            <tbody>
              <% if @orders.any? %>
                <% @orders.each do |order| %>
                  <% row_class =
                       if order.delivery_date.present? && order.delivery_date < Date.current && order.status != Cart::STATUSES[:delivered]
                         'table-danger'
                       elsif order.delivery_date == Date.current && [Cart::STATUSES[:no_status], Cart::STATUSES[:seen], Cart::STATUSES[:in_production]].include?(order.status)
                         'table-warning'
                       else
                         ''
                       end %>
                  <tr class="align-middle <%= row_class %>">
                    <td class="text-muted small">
                      <div class="fw-semibold">#<%= order.id %></div>
                      <div><%= l(order.created_at, format: :short) %></div>
                    </td>
                    <td class="text-muted small">
                      <div class="fw-semibold text-dark"><%= order.customer_name.presence || 'N/A' %></div>
                      <div class="d-flex gap-2">
                        <span><i class="fa-solid fa-phone fa-xs me-1"></i><%= order.customer_phone.presence || '–' %></span>
                      </div>
                      <div class="d-flex gap-2">
                        <span><i class="fa-solid fa-envelope fa-xs me-1"></i><%= order.contact_email || '–' %></span>
                      </div>
                    </td>
                    <td class="text-muted small">
                      <div class="fw-semibold text-dark"><%= human_delivery_method(order) %></div>
                      <div><i class="fa-regular fa-calendar fa-xs me-1"></i><%= order.delivery_date.present? ? l(order.delivery_date) : '–' %></div>
                      <div><i class="fa-solid fa-location-dot fa-xs me-1"></i><%= order.county.presence || '–' %></div>
                    </td>
                    <td>
                      <%= order_status_badge(order) %>
                    </td>
                    <td class="text-muted small">
                      <div class="fw-semibold text-dark"><%= format_order_total(order) %></div>
                      <div class="small">Linii: <%= order.line_item_count %> · Cant: <%= format_order_quantity(order) %></div>
                    </td>
                    <td class="text-end align-middle">
                      <div class="d-flex flex-wrap justify-content-end gap-1 mb-1">
                        <% Cart::STATUSES.values.each do |status_value| %>
                          <% if [Cart::STATUSES[:canceled], Cart::STATUSES[:refunded]].include?(status_value) %>
                            <% next %>
                          <% end %>

                          <% if status_value == order.status %>
                            <span class="btn btn-sm btn-warning px-2 py-0 disabled">
                              <%= Cart::STATUS_LABELS[status_value] || status_value.to_s.titleize %>
                            </span>
                            <% next %>
                          <% end %>

                          <%= button_to Cart::STATUS_LABELS[status_value] || status_value.to_s.titleize,
                                        dashboard_order_path(order),
                                        params: { order: { status: status_value } },
                                        method: :patch,
                                        form_class: 'd-inline',
                                        data: { turbo: false, confirm: 'Actualizezi statusul comenzii?' },
                                        class: order_status_button_class(order, status_value) %>
                        <% end %>
                      </div>
                      <div class="d-flex justify-content-end gap-1 mt-1">
                        <%= link_to dashboard_order_path(order), class: 'btn btn-link btn-sm px-1', title: 'Detalii' do %>
                          <i class="fa-regular fa-eye"></i>
                        <% end %>
                        <%= button_to resend_emails_dashboard_order_path(order),
                                      method: :post,
                                      form_class: 'd-inline',
                                      data: { turbo: false },
                                      class: 'btn btn-outline-primary btn-sm px-2',
                                      title: 'Retrimite emailuri' do %>
                          <i class="fa-solid fa-paper-plane"></i>
                        <% end %>
                        <button type="button"
                                class="btn btn-outline-danger btn-sm px-2"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteOrderModal-<%= order.id %>"
                                title="Șterge">
                          <i class="fa-regular fa-trash-can"></i>
                        </button>
                      </div>
                      <div class="d-flex justify-content-end gap-1 mt-1">
                        <% [Cart::STATUSES[:canceled], Cart::STATUSES[:refunded]].each do |status_value| %>
                          <% if status_value == order.status %>
                            <span class="btn btn-sm btn-warning px-2 py-0 disabled">
                              <%= Cart::STATUS_LABELS[status_value] || status_value.to_s.titleize %>
                            </span>
                            <% next %>
                          <% end %>

                          <%= button_to Cart::STATUS_LABELS[status_value] || status_value.to_s.titleize,
                                        dashboard_order_path(order),
                                        params: { order: { status: status_value } },
                                        method: :patch,
                                        form_class: 'd-inline',
                                        data: { turbo: false, confirm: 'Actualizezi statusul comenzii?' },
                                        class: order_status_button_class(order, status_value) %>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">Nu există comenzi care să corespundă filtrării curente.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <div class="card-footer bg-white border-0">
          <% if @pagy.pages > 1 %>
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
              <span class="text-muted small">Rezultate <%= @pagy.from %> - <%= @pagy.to %> din <%= @pagy.count %></span>
              <div class="d-flex justify-content-md-end w-100">
                <%= pagy_bootstrap_nav(@pagy) %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <% @orders.each do |order| %>
      <div class="modal fade" id="deleteOrderModal-<%= order.id %>" tabindex="-1" aria-labelledby="deleteOrderModalLabel-<%= order.id %>" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteOrderModalLabel-<%= order.id %>">Șterge comanda #<%= order.id %></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Închide"></button>
            </div>
            <div class="modal-body">
              <p class="mb-2">Această acțiune este definitivă.</p>
              <ul class="small text-muted mb-3">
                <li>Client: <strong><%= order.customer_name.presence || 'Nespecificat' %></strong></li>
                <li>Valoare: <strong><%= format_order_total(order) %></strong></li>
                <li>Articole: <strong><%= order.line_item_count %></strong> (cantitate <%= format_order_quantity(order) %>)</li>
              </ul>
              <p class="text-warning small mb-0">Confirmă doar dacă ești sigur că nu mai ai nevoie de această comandă.</p>
            </div>
            <div class="modal-footer d-flex justify-content-between">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Anulează</button>
              <%= button_to 'Șterge definitiv', dashboard_order_path(order),
                            method: :delete,
                            form_class: 'd-inline',
                            data: { turbo: false },
                            class: 'btn btn-danger' %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

  </div>
</div>
