<div class="container py-5">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <div>
      <%= link_to '← Înapoi la comenzi', dashboard_orders_path, class: 'text-decoration-none small', style: 'color: #64748b;' %>
      <h1 class="h3 mb-0" style="color: #1e293b; font-weight: 600;">Comanda #<%= @order.id %></h1>
      <p class="text-muted small mb-0">Creată <%= l(@order.created_at, format: :long) %> • Ultima actualizare <%= time_ago_in_words(@order.updated_at) %> în urmă</p>
    </div>
    <div>
      <%= order_status_badge(@order) %>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header py-3 d-flex justify-content-between align-items-center" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h2 class="h5 mb-0" style="color: #1e293b; font-weight: 600;">Produse comandate</h2>
          <span class="text-muted small">Total: <strong><%= format_order_total(@order) %></strong></span>
        </div>
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead style="background: #f8fafc;">
              <tr>
                <th>Produs</th>
                <th>Cantitate</th>
                <th>Preț unitar</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <% @items.each do |item| %>
                <tr>
                  <td>
                    <strong><%= item.name %></strong>
                    <% if item.recipe.present? %>
                      <div class="text-muted small">ID rețetă: <%= item.recipe.id %></div>
                    <% end %>
                  </td>
                  <td class="text-muted">
                    <% quantity = item.quantity.to_f %>
                    <%= quantity == quantity.to_i ? quantity.to_i : number_with_precision(quantity, precision: 2) %>
                    <%= item.kg_buc %>
                  </td>
                  <td><%= item.price.format %></td>
                  <td class="fw-semibold"><%= item.total.format %></td>
                </tr>
                <% if item.item_extras.any? %>
                  <tr>
                    <td colspan="4" class="ps-3">
                      <ul class="list-unstyled mb-0 small text-muted">
                        <% item.item_extras.each do |ie| %>
                          <li>+ <%= ie.name %> — <%= Money.new(ie.price_cents, Money.default_currency).format %></li>
                        <% end %>
                      </ul>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
        <div class="card-footer bg-white border-0 d-flex justify-content-between">
          <span class="text-muted small">Produse: <strong><%= @order.line_item_count %></strong></span>
          <span class="text-muted small">Cantitate totală: <strong><%= format_order_quantity(@order) %></strong></span>
        </div>
      </div>

      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header py-3" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h2 class="h5 mb-0" style="color: #1e293b; font-weight: 600;">Informații client</h2>
        </div>
        <div class="card-body">
          <%= render_contact_detail('Nume', @order.customer_full_name) %>
          <%= render_contact_detail('Telefon', @order.customer_phone) %>
          <%= render_contact_detail('Email', @order.contact_email) %>
          <%= render_contact_detail('Metodă livrare', human_delivery_method(@order)) %>
          <%= render_contact_detail('Data livrării', @order.delivery_date.present? ? l(@order.delivery_date) : nil) %>
          <%= render_contact_detail('Județ', @order.county) %>
          <%= render_contact_detail('Adresă livrare', @order.delivery_address) %>
          <%= render_contact_detail('Notițe client', @order.customer_notes) %>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h6 mb-0">Actualizează comanda</h3>
          <p class="text-muted small mb-0">Setează statusul, actualizează datele de contact sau adaugă notițe interne.</p>
        </div>
        <div class="card-body">
          <%= form_with model: [:dashboard, @order], url: dashboard_order_path(@order), method: :patch, data: { turbo: false } do |f| %>
            <div class="mb-3">
              <%= f.label :status, 'Status comandă', class: 'form-label small text-muted' %>
              <%= f.select :status, options_for_select(order_status_options, @order.status), {}, class: 'form-select' %>
            </div>
            <div class="mb-3">
              <%= f.label :method_of_delivery, 'Metodă livrare', class: 'form-label small text-muted' %>
              <%= f.select :method_of_delivery,
                           options_for_select([['Livrare', 'delivery'], ['Ridicare personală', 'pickup']], @order.method_of_delivery),
                           {},
                           class: 'form-select' %>
            </div>
            <div class="mb-3">
              <%= f.label :delivery_date, 'Data livrării', class: 'form-label small text-muted' %>
              <%= f.date_field :delivery_date, class: 'form-control', value: @order.delivery_date %>
            </div>
            <div class="mb-3">
              <%= f.label :county, 'Județ', class: 'form-label small text-muted' %>
              <%= f.select :county,
                           options_for_select([['Selectează județul', '']] + Cart::COUNTIES.map { |county| [county, county] }, @order.county),
                           {},
                           class: 'form-select' %>
            </div>
            <div class="mb-3">
              <%= f.label :customer_full_name, 'Nume client', class: 'form-label small text-muted' %>
              <%= f.text_field :customer_full_name, class: 'form-control' %>
            </div>
            <div class="mb-3">
              <%= f.label :customer_phone, 'Telefon', class: 'form-label small text-muted' %>
              <%= f.text_field :customer_phone, class: 'form-control' %>
            </div>
            <div class="mb-3">
              <%= f.label :email, 'Email', class: 'form-label small text-muted' %>
              <%= f.email_field :email, class: 'form-control' %>
            </div>
            <div class="mb-3">
              <%= f.label :delivery_address, 'Adresă de livrare', class: 'form-label small text-muted' %>
              <%= f.text_area :delivery_address, rows: 2, class: 'form-control' %>
            </div>
            <div class="mb-3">
              <%= f.label :admin_notes, 'Notițe interne', class: 'form-label small text-muted' %>
              <%= f.text_area :admin_notes, rows: 4, class: 'form-control', placeholder: 'Ex.: confirmat telefonic, livrare după ora 16:00' %>
            </div>
            <div class="d-grid">
              <%= f.submit 'Salvează modificările', class: 'btn btn-primary btn-lg' %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h6 mb-0">Istoric comanda</h3>
        </div>
        <div class="card-body">
          <p class="small text-muted mb-2">Creată: <strong><%= l(@order.created_at, format: :long) %></strong></p>
          <p class="small text-muted mb-2">Actualizată: <strong><%= l(@order.updated_at, format: :long) %></strong></p>
          <% if @order.fulfilled_at.present? %>
            <p class="small text-muted mb-2">Finalizată: <strong><%= l(@order.fulfilled_at, format: :long) %></strong></p>
          <% end %>
          <% if @order.cancelled_at.present? %>
            <p class="small text-muted mb-2">Anulată: <strong><%= l(@order.cancelled_at, format: :long) %></strong></p>
          <% end %>
          <% if @order.stripe_checkout_session_id.present? %>
            <hr>
            <p class="small text-muted mb-1">Stripe session</p>
            <code class="small"><%= @order.stripe_checkout_session_id %></code>
          <% end %>
          <% if @order.stripe_payment_intent_id.present? %>
            <p class="small text-muted mb-1 mt-2">Stripe payment intent</p>
            <code class="small"><%= @order.stripe_payment_intent_id %></code>
          <% end %>
          <% if @stripe_payment_status.present? %>
            <p class="small text-muted mb-1 mt-2">Stripe status</p>
            <span class="badge bg-light text-dark"><%= @stripe_payment_status %></span>
          <% end %>
          <% if @stripe_receipt_url.present? %>
            <p class="small text-muted mb-1 mt-2">Confirmare Stripe</p>
            <%= link_to 'Deschide chitanța', @stripe_receipt_url, target: '_blank', rel: 'noopener', class: 'btn btn-sm btn-outline-primary' %>
          <% end %>
          <% if @order.guest_token.present? %>
            <p class="small text-muted mb-1 mt-2">Token invitat</p>
            <code class="small"><%= @order.guest_token %></code>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
