<div class="container-fluid py-5" style="margin-top: 20dvh; max-width: 1400px;">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1" style="color: #1e293b; font-weight: 700;">Analiză Trafic & Comportament</h1>
      <p class="text-muted mb-0">Monitorizare completă a activității utilizatorilor și performanței site-ului</p>
    </div>
    <div class="d-flex gap-2">
      <%= link_to 'Audit Logs', dashboard_audit_logs_path, class: 'btn btn-sm', style: 'background: #1e293b; color: white; border-radius: 6px;' %>
      <%= link_to 'Dashboard', dashboard_path, class: 'btn btn-sm', style: 'background: white; color: #475569; border: 1px solid #e5e7eb; border-radius: 6px;' %>
    </div>
  </div>

  <!-- Filters for Combined Traffic Analysis -->
  <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
    <div class="card-body">
      <h6 class="mb-3" style="color: #1e293b; font-weight: 600;">
        <i class="fas fa-filter me-2"></i>Filtre Trafic Combinat: Sursă × Locație
      </h6>
      <%= form_with url: dashboard_analytics_path, method: :get, local: true, class: 'row g-3' do |f| %>
        <div class="col-md-5">
          <%= f.label :source_filter, 'Sursă Trafic', class: 'form-label' %>
          <%= f.select :source_filter, 
              options_for_select(@available_sources.map { |s| [s, s] }, @filtered_source), 
              { include_blank: 'Toate sursele' }, 
              class: 'form-select' %>
        </div>
        
        <div class="col-md-5">
          <%= f.label :country_filter, 'Țară', class: 'form-label' %>
          <%= f.select :country_filter, 
              options_for_select(@available_countries.map { |c| [c, c] }, @filtered_country), 
              { include_blank: 'Toate țările' }, 
              class: 'form-select' %>
        </div>
        
        <div class="col-md-2 d-flex align-items-end gap-2">
          <%= f.submit 'Filtrează', class: 'btn', style: 'background: #1e293b; color: white; border: none; border-radius: 6px;' %>
          <%= link_to 'Resetează', dashboard_analytics_path, class: 'btn', style: 'background: white; color: #475569; border: 1px solid #e5e7eb; border-radius: 6px;' %>
        </div>
      <% end %>
      
      <% if @filtered_source.present? || @filtered_country.present? %>
        <div class="mt-3">
          <span class="badge bg-info-subtle text-info-emphasis me-2">
            <i class="fas fa-info-circle me-1"></i>
            Filtre active:
            <% if @filtered_source.present? %>
              Sursă: <strong><%= @filtered_source %></strong>
            <% end %>
            <% if @filtered_country.present? %>
              <%= ' | ' if @filtered_source.present? %>
              Țară: <strong><%= @filtered_country %></strong>
            <% end %>
          </span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card h-100" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <p class="text-muted small mb-1 text-uppercase" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px;">Total Vizite</p>
              <h3 class="mb-0" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@total_visits) %></h3>
            </div>
            <div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-chart-line" style="color: #1e293b;"></i>
            </div>
          </div>
          <p class="text-muted small mb-0">
            <strong><%= number_with_delimiter(@total_unique_visitors) %></strong> vizitatori unici
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <p class="text-muted small mb-1 text-uppercase" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px;">Astăzi</p>
              <h3 class="mb-0" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@today_visits) %></h3>
            </div>
            <div style="width: 40px; height: 40px; background: <%= @daily_growth >= 0 ? '#dcfce7' : '#fee2e2' %>; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-<%= @daily_growth >= 0 ? 'arrow-up' : 'arrow-down' %>" style="color: <%= @daily_growth >= 0 ? '#16a34a' : '#dc2626' %>;"></i>
            </div>
          </div>
          <p class="small mb-0" style="color: <%= @daily_growth >= 0 ? '#16a34a' : '#dc2626' %>; font-weight: 600;">
            <%= @daily_growth >= 0 ? '+' : '' %><%= @daily_growth %>% vs ieri
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <p class="text-muted small mb-1 text-uppercase" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px;">Luna Curentă</p>
              <h3 class="mb-0" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@month_visits) %></h3>
            </div>
            <div style="width: 40px; height: 40px; background: <%= @monthly_growth >= 0 ? '#dcfce7' : '#fee2e2' %>; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-<%= @monthly_growth >= 0 ? 'arrow-up' : 'arrow-down' %>" style="color: <%= @monthly_growth >= 0 ? '#16a34a' : '#dc2626' %>;"></i>
            </div>
          </div>
          <p class="small mb-0" style="color: <%= @monthly_growth >= 0 ? '#16a34a' : '#dc2626' %>; font-weight: 600;">
            <%= @monthly_growth >= 0 ? '+' : '' %><%= @monthly_growth %>% vs luna trecută
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <p class="text-muted small mb-1 text-uppercase" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px;">Bounce Rate</p>
              <h3 class="mb-0" style="color: #1e293b; font-weight: 700;"><%= @bounce_rate %>%</h3>
            </div>
            <div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user-slash" style="color: #475569;"></i>
            </div>
          </div>
          <p class="text-muted small mb-0">
            Sesiuni cu o singură pagină
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Secondary Metrics -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body text-center py-3">
          <h4 class="mb-1" style="color: #1e293b; font-weight: 700;"><%= Time.at(@avg_session_duration).utc.strftime("%M:%S") %></h4>
          <p class="text-muted small mb-0">Durată medie sesiune</p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body text-center py-3">
          <h4 class="mb-1" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@total_events) %></h4>
          <p class="text-muted small mb-0">Total evenimente</p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body text-center py-3">
          <h4 class="mb-1" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@new_visitors) %></h4>
          <p class="text-muted small mb-0">Vizitatori noi (30 zile)</p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body text-center py-3">
          <h4 class="mb-1" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@returning_visitors) %></h4>
          <p class="text-muted small mb-0">Vizitatori care revin</p>
        </div>
      </div>
    </div>
  </div>


  <!-- Traffic Charts -->
  <div class="row g-4 mb-4">
    <div class="col-lg-8">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Trafic pe zile (Ultimele 30 zile)</h5>
        </div>
        <div class="card-body">
          <%= line_chart @visits_by_day, 
              colors: ['#1e293b'], 
              height: '350px',
              library: { 
                scales: { 
                  y: { beginAtZero: true },
                  x: { grid: { display: false } }
                },
                plugins: {
                  legend: { display: false }
                }
              } %>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Tipuri Utilizatori</h5>
        </div>
        <div class="card-body">
          <%= pie_chart({ 
                "Autentificați" => @registered_user_visits, 
                "Guest" => @guest_visits 
              },
              height: '350px',
              colors: ['#1e293b', '#cbd5e1'],
              donut: true,
              library: {
                plugins: {
                  legend: { position: 'bottom' }
                }
              }) %>
        </div>
      </div>
    </div>
  </div>

  <!-- Time-based Analysis -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Trafic pe ore (Astăzi)</h5>
        </div>
        <div class="card-body">
          <%= column_chart @hourly_visits, 
              colors: ['#475569'],
              height: '300px',
              library: { 
                scales: { 
                  y: { beginAtZero: true }
                },
                plugins: {
                  legend: { display: false }
                }
              } %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Trafic pe zi a săptămânii</h5>
        </div>
        <div class="card-body">
          <% day_names = { 0 => 'Duminică', 1 => 'Luni', 2 => 'Marți', 3 => 'Miercuri', 4 => 'Joi', 5 => 'Vineri', 6 => 'Sâmbătă' } %>
          <%= column_chart @visits_by_day_of_week.transform_keys { |k| day_names[k] || k },
              colors: ['#64748b'],
              height: '300px',
              library: { 
                scales: { 
                  y: { beginAtZero: true }
                },
                plugins: {
                  legend: { display: false }
                }
              } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Long-term Trends -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Trend Săptămânal (12 săptămâni)</h5>
        </div>
        <div class="card-body">
          <%= line_chart @visits_by_week, 
              colors: ['#334155'], 
              height: '300px',
              library: { 
                scales: { 
                  y: { beginAtZero: true }
                },
                plugins: {
                  legend: { display: false }
                }
              } %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Trend Lunar (12 luni)</h5>
        </div>
        <div class="card-body">
          <%= line_chart @visits_by_month, 
              colors: ['#1e293b'], 
              height: '300px',
              library: { 
                scales: { 
                  y: { beginAtZero: true }
                },
                plugins: {
                  legend: { display: false }
                }
              } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Device & Browser Stats -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Dispozitive</h5>
        </div>
        <div class="card-body">
          <%= pie_chart @device_types, 
              height: '300px',
              colors: ['#1e293b', '#475569', '#64748b', '#94a3b8'],
              donut: true,
              library: {
                plugins: {
                  legend: { position: 'bottom' }
                }
              } %>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Browsere</h5>
        </div>
        <div class="card-body">
          <%= pie_chart @browsers, 
              height: '300px',
              colors: ['#1e293b', '#334155', '#475569', '#64748b', '#94a3b8'],
              donut: true,
              library: {
                plugins: {
                  legend: { position: 'bottom' }
                }
              } %>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Sisteme Operare</h5>
        </div>
        <div class="card-body">
          <%= pie_chart @operating_systems, 
              height: '300px',
              colors: ['#1e293b', '#334155', '#475569', '#64748b', '#94a3b8'],
              donut: true,
              library: {
                plugins: {
                  legend: { position: 'bottom' }
                }
              } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Events Analysis -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Evenimente pe zile (30 zile)</h5>
        </div>
        <div class="card-body">
          <%= area_chart @events_by_day, 
              colors: ['#475569'], 
              height: '300px',
              library: { 
                scales: { 
                  y: { beginAtZero: true }
                },
                plugins: {
                  legend: { display: false }
                }
              } %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Top 10 Evenimente</h5>
        </div>
        <div class="card-body">
          <% if @top_events.any? %>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead style="background: #f8fafc;">
                  <tr>
                    <th style="border: none; padding: 0.75rem;">Poziție</th>
                    <th style="border: none; padding: 0.75rem;">Eveniment</th>
                    <th class="text-end" style="border: none; padding: 0.75rem;">Număr</th>
                  </tr>
                </thead>
                <tbody>
                  <% @top_events.each_with_index do |(event_name, count), index| %>
                    <tr>
                      <td style="padding: 0.75rem;">
                        <span class="badge" style="background: <%= index < 3 ? '#1e293b' : '#e2e8f0' %>; color: <%= index < 3 ? 'white' : '#475569' %>; font-weight: 600;">#<%= index + 1 %></span>
                      </td>
                      <td style="padding: 0.75rem;"><code style="color: #1e293b; background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px;"><%= event_name %></code></td>
                      <td class="text-end" style="padding: 0.75rem;">
                        <strong style="color: #1e293b;"><%= number_with_delimiter(count) %></strong>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted text-center py-4 mb-0">Nu există date disponibile</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Pages & Referrers -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Top 10 Pagini de intrare</h5>
        </div>
        <div class="card-body">
          <% if @landing_pages.any? %>
            <div class="list-group list-group-flush">
              <% @landing_pages.each_with_index do |(page, count), index| %>
                <div class="list-group-item border-0 px-0 py-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                      <span class="badge" style="background: #f1f5f9; color: #475569; font-weight: 600; flex-shrink: 0;">#<%= index + 1 %></span>
                      <span class="text-truncate" style="color: #1e293b; font-size: 0.875rem;"><%= page %></span>
                    </div>
                    <strong style="color: #1e293b; margin-left: 1rem; flex-shrink: 0;"><%= number_with_delimiter(count) %></strong>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted text-center py-4 mb-0">Nu există date disponibile</p>
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
          <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">Top 10 Surse Trafic (Referrers)</h5>
        </div>
        <div class="card-body">
          <% if @top_referrers.any? %>
            <div class="list-group list-group-flush">
              <% @top_referrers.each_with_index do |(referrer, count), index| %>
                <div class="list-group-item border-0 px-0 py-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                      <span class="badge" style="background: #f1f5f9; color: #475569; font-weight: 600; flex-shrink: 0;">#<%= index + 1 %></span>
                      <span class="text-truncate" style="color: #1e293b; font-size: 0.875rem;"><%= referrer %></span>
                    </div>
                    <strong style="color: #1e293b; margin-left: 1rem; flex-shrink: 0;"><%= number_with_delimiter(count) %></strong>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted text-center py-4 mb-0">Nu există date disponibile</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Geographic Distribution -->
  <div class="mb-4">
    <h4 class="mb-3" style="color: #1e293b; font-weight: 700;">
      <i class="fas fa-globe-americas me-2" style="color: #475569;"></i>
      Distribuție Geografică
    </h4>
  </div>

  <!-- Geographic Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body text-center py-3">
          <h3 class="mb-1" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@total_countries) %></h3>
          <p class="text-muted small mb-0">Țări diferite (30 zile)</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
        <div class="card-body text-center py-3">
          <h3 class="mb-1" style="color: #1e293b; font-weight: 700;"><%= number_with_delimiter(@total_cities) %></h3>
          <p class="text-muted small mb-0">Orașe diferite (30 zile)</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Geographic Charts -->
  <% if @countries.any? || @regions.any? || @cities.any? %>
    <div class="row g-4 mb-4">
      <% if @countries.any? %>
        <div class="col-lg-6">
          <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
            <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
              <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
                <i class="fas fa-flag me-2"></i>Top 10 Țări
              </h5>
            </div>
            <div class="card-body">
              <%= bar_chart @countries, 
                  colors: ['#1e293b'],
                  height: '350px',
                  library: { 
                    indexAxis: 'y',
                    scales: { 
                      x: { beginAtZero: true }
                    },
                    plugins: {
                      legend: { display: false }
                    }
                  } %>
            </div>
          </div>
        </div>
      <% end %>

      <% if @regions.any? %>
        <div class="col-lg-6">
          <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
            <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
              <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
                <i class="fas fa-map-marked-alt me-2"></i>Top 10 Regiuni
              </h5>
            </div>
            <div class="card-body">
              <%= bar_chart @regions, 
                  colors: ['#475569'],
                  height: '350px',
                  library: { 
                    indexAxis: 'y',
                    scales: { 
                      x: { beginAtZero: true }
                    },
                    plugins: {
                      legend: { display: false }
                    }
                  } %>
            </div>
          </div>
        </div>
      <% end %>

      <% if @cities.any? %>
        <div class="col-lg-6">
          <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
            <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
              <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
                <i class="fas fa-city me-2"></i>Top 10 Orașe
              </h5>
            </div>
            <div class="card-body">
              <%= bar_chart @cities, 
                  colors: ['#64748b'],
                  height: '350px',
                  library: { 
                    indexAxis: 'y',
                    scales: { 
                      x: { beginAtZero: true }
                    },
                    plugins: {
                      legend: { display: false }
                    }
                  } %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Geographic Table with Combined Data -->
      <div class="col-lg-6">
        <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
          <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
            <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
              <i class="fas fa-list me-2"></i>Detalii Locații
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead style="background: #f8fafc;">
                  <tr>
                    <th style="border: none; padding: 0.75rem;">Poziție</th>
                    <th style="border: none; padding: 0.75rem;">Locație</th>
                    <th class="text-end" style="border: none; padding: 0.75rem;">Vizite</th>
                    <th class="text-end" style="border: none; padding: 0.75rem;">%</th>
                  </tr>
                </thead>
                <tbody>
                  <% if @countries.any? %>
                    <% total_geo_visits = @countries.sum { |_, count| count } %>
                    <% @countries.first(5).each_with_index do |(location, count), index| %>
                      <tr>
                        <td style="padding: 0.75rem;">
                          <span class="badge" style="background: <%= index < 3 ? '#1e293b' : '#e2e8f0' %>; color: <%= index < 3 ? 'white' : '#475569' %>; font-weight: 600;">#<%= index + 1 %></span>
                        </td>
                        <td style="padding: 0.75rem;">
                          <strong style="color: #1e293b;"><%= location %></strong>
                          <span class="badge bg-primary-subtle text-primary-emphasis ms-2">Țară</span>
                        </td>
                        <td class="text-end" style="padding: 0.75rem;">
                          <strong style="color: #1e293b;"><%= number_with_delimiter(count) %></strong>
                        </td>
                        <td class="text-end" style="padding: 0.75rem;">
                          <span style="color: #64748b;"><%= ((count.to_f / total_geo_visits * 100).round(1)) %>%</span>
                        </td>
                      </tr>
                    <% end %>
                  <% else %>
                    <tr>
                      <td colspan="4" class="text-center py-4 text-muted">Nu există date geografice disponibile</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
      <div class="card-body text-center py-5">
        <i class="fas fa-globe fa-3x mb-3" style="color: #cbd5e1;"></i>
        <p class="text-muted mb-0">Nu există încă date geografice. Datele de localizare vor apărea când vizitatorii accesează site-ul.</p>
      </div>
    </div>
  <% end %>

  <!-- Combined Traffic Analysis: Source × Location -->
  <% if @source_by_location.any? %>
    <div class="mb-4">
      <h4 class="mb-3" style="color: #1e293b; font-weight: 700;">
        <i class="fas fa-network-wired me-2" style="color: #475569;"></i>
        Trafic Combinat: Sursă × Locație
      </h4>
    </div>

    <div class="card mb-4" style="border: 1px solid #e5e7eb; border-radius: 8px;">
      <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
        <h5 class="mb-0" style="color: #1e293b; font-weight: 600;">
          <i class="fas fa-table me-2"></i>Vizite per Sursă și Țară (Top 20)
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead style="background: #f8fafc;">
              <tr>
                <th style="border: none; padding: 0.75rem;">Poziție</th>
                <th style="border: none; padding: 0.75rem;">Sursă Trafic</th>
                <th style="border: none; padding: 0.75rem;">Țară</th>
                <th class="text-end" style="border: none; padding: 0.75rem;">Vizite</th>
                <th class="text-end" style="border: none; padding: 0.75rem;">% din Total</th>
              </tr>
            </thead>
            <tbody>
              <% total_combined = @source_by_location.values.flatten(1).sum { |_, count| count } %>
              <% @source_by_location.flat_map { |domain, locations| locations.map { |(_, country), count| [domain, country, count] } }
                  .sort_by { |_, _, count| -count }
                  .first(20)
                  .each_with_index do |(domain, country, count), index| %>
                <tr>
                  <td style="padding: 0.75rem;">
                    <span class="badge" style="background: <%= index < 3 ? '#1e293b' : '#e2e8f0' %>; color: <%= index < 3 ? 'white' : '#475569' %>; font-weight: 600;">#<%= index + 1 %></span>
                  </td>
                  <td style="padding: 0.75rem;">
                    <code style="color: #1e293b; background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;"><%= domain %></code>
                  </td>
                  <td style="padding: 0.75rem;">
                    <strong style="color: #475569;"><%= country %></strong>
                  </td>
                  <td class="text-end" style="padding: 0.75rem;">
                    <strong style="color: #1e293b;"><%= number_with_delimiter(count) %></strong>
                  </td>
                  <td class="text-end" style="padding: 0.75rem;">
                    <span style="color: #64748b;"><%= ((count.to_f / total_combined * 100).round(1)) %>%</span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Source breakdown by location -->
    <div class="row g-4 mb-4">
      <% @source_by_location.first(3).each do |domain, locations| %>
        <div class="col-lg-4">
          <div class="card" style="border: 1px solid #e5e7eb; border-radius: 8px;">
            <div class="card-header" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
              <h6 class="mb-0" style="color: #1e293b; font-weight: 600;">
                <i class="fas fa-external-link-alt me-2"></i><%= domain %>
              </h6>
            </div>
            <div class="card-body">
              <%= pie_chart locations.to_h.transform_keys { |(_, country)| country },
                  height: '250px',
                  colors: ['#1e293b', '#334155', '#475569', '#64748b', '#94a3b8', '#cbd5e1'],
                  donut: true,
                  library: {
                    plugins: {
                      legend: { position: 'bottom' }
                    }
                  } %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
