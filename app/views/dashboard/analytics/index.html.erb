<% filters = @analytics[:filters] %>
<% overview = @analytics[:overview] %>
<% engagement = @analytics[:engagement] %>
<% commerce = @analytics[:commerce] %>
<% funnel = @analytics[:funnel] %>
<% charts = @analytics[:charts] %>
<% breakdowns = @analytics[:breakdowns] %>
<% tables = @analytics[:tables] %>

<% format_duration = lambda do |seconds|
     total = seconds.to_i
     hours = total / 3600
     minutes = (total % 3600) / 60
     secs = total % 60
     hours.positive? ? format('%02d:%02d:%02d', hours, minutes, secs) : format('%02d:%02d', minutes, secs)
   end %>

<% format_money = lambda do |cents, precision = 0|
     amount = cents.to_f / 100
     number = number_with_precision(amount, precision: precision, delimiter: '.', separator: ',')
     "#{number} lei"
   end %>

<div class="analytics-page container-fluid">
  <div class="analytics-page__header">
    <div>
      <h1>Analytics</h1>
      <p>Panou complet pentru trafic, comportament, comenzi și conversii.</p>
    </div>
    <div class="analytics-page__range">
      <span>Perioadă analizată</span>
      <strong><%= filters[:range_label] %></strong>
    </div>
  </div>

  <div class="analytics-panel analytics-panel--filters">
    <%= form_with url: dashboard_analytics_path, method: :get, local: true, class: 'row g-2 align-items-end' do |f| %>
      <div class="col-12 col-md-3 col-lg-2">
        <%= f.label :period, 'Interval', class: 'form-label' %>
        <%= f.select :period,
            options_for_select(filters[:period_options].map { |key, label| [label, key] }, filters[:period]),
            {},
            class: 'form-select' %>
      </div>

      <div class="col-6 col-md-3 col-lg-2">
        <%= f.label :from, 'De la', class: 'form-label' %>
        <%= f.date_field :from, value: filters[:from], class: 'form-control' %>
      </div>

      <div class="col-6 col-md-3 col-lg-2">
        <%= f.label :to, 'Până la', class: 'form-label' %>
        <%= f.date_field :to, value: filters[:to], class: 'form-control' %>
      </div>

      <div class="col-12 col-md-6 col-lg-2">
        <%= f.label :source_filter, 'Sursă trafic', class: 'form-label' %>
        <%= f.select :source_filter,
            options_for_select(filters[:available_sources].map { |source| [source, source] }, filters[:source_filter]),
            { include_blank: 'Toate sursele' },
            class: 'form-select' %>
      </div>

      <div class="col-12 col-md-6 col-lg-2">
        <%= f.label :country_filter, 'Țară', class: 'form-label' %>
        <%= f.select :country_filter,
            options_for_select(filters[:available_countries].map { |country| [country, country] }, filters[:country_filter]),
            { include_blank: 'Toate țările' },
            class: 'form-select' %>
      </div>

      <div class="col-12 col-lg-2 d-flex gap-2">
        <%= f.submit 'Aplică', class: 'btn btn-dark w-100' %>
        <%= link_to 'Reset', dashboard_analytics_path, class: 'btn btn-outline-secondary w-100' %>
      </div>
    <% end %>
  </div>

  <div class="analytics-kpi-grid">
    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Vizite</span>
      <strong><%= number_with_delimiter(overview[:visits]) %></strong>
      <p class="<%= overview[:visits_growth] >= 0 ? 'is-positive' : 'is-negative' %>">
        <%= overview[:visits_growth] >= 0 ? '+' : '' %><%= overview[:visits_growth] %>% vs perioada anterioară
      </p>
    </article>

    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Vizitatori unici</span>
      <strong><%= number_with_delimiter(overview[:unique_visitors]) %></strong>
      <p class="<%= overview[:unique_visitors_growth] >= 0 ? 'is-positive' : 'is-negative' %>">
        <%= overview[:unique_visitors_growth] >= 0 ? '+' : '' %><%= overview[:unique_visitors_growth] %>% vs perioada anterioară
      </p>
    </article>

    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Evenimente</span>
      <strong><%= number_with_delimiter(overview[:events]) %></strong>
      <p><%= overview[:events_per_visit] %> evenimente / vizită</p>
    </article>

    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Bounce rate</span>
      <strong><%= overview[:bounce_rate] %>%</strong>
      <p>Sesiuni cu maximum 1 eveniment</p>
    </article>

    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Durată medie sesiune</span>
      <strong><%= format_duration.call(overview[:avg_session_seconds]) %></strong>
      <p>Calculată după timestamps Ahoy events</p>
    </article>

    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Comenzi create</span>
      <strong><%= number_with_delimiter(commerce[:orders_created]) %></strong>
      <p><%= commerce[:checkout_completion_rate] %>% ajung plătite</p>
    </article>

    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Comenzi plătite</span>
      <strong><%= number_with_delimiter(commerce[:paid_orders]) %></strong>
      <p><%= commerce[:visit_to_paid_conversion_rate] %>% din total vizite</p>
    </article>

    <article class="analytics-kpi">
      <span class="analytics-kpi__label">Venit estimat</span>
      <strong><%= format_money.call(commerce[:revenue_cents], 0) %></strong>
      <p>AOV: <%= format_money.call(commerce[:average_order_value_cents], 0) %></p>
    </article>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-xl-8">
      <section class="analytics-panel">
        <header>
          <h2>Trafic și activitate</h2>
          <p>Vizite și evenimente pe zile</p>
        </header>
        <%= line_chart [
              { name: 'Vizite', data: charts[:visits_by_day] },
              { name: 'Evenimente', data: charts[:events_by_day] }
            ],
            height: '320px',
            colors: ['#0f172a', '#0ea5e9'],
            library: {
              scales: {
                y: { beginAtZero: true },
                x: { grid: { display: false } }
              }
            } %>
      </section>
    </div>

    <div class="col-12 col-xl-4">
      <section class="analytics-panel">
        <header>
          <h2>Funnel conversie</h2>
          <p>De la trafic la comandă plătită</p>
        </header>

        <div class="analytics-funnel">
          <% funnel[:stages].each do |stage| %>
            <div class="analytics-funnel__row">
              <div class="d-flex justify-content-between">
                <span><%= stage[:label] %></span>
                <strong><%= number_with_delimiter(stage[:count]) %></strong>
              </div>
              <div class="progress" role="progressbar" aria-valuenow="<%= stage[:rate_from_visits] %>" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar" style="width: <%= stage[:rate_from_visits] %>%"></div>
              </div>
              <small><%= stage[:rate_from_visits] %>% din vizite</small>
            </div>
          <% end %>
        </div>
      </section>
    </div>

    <div class="col-12 col-lg-6">
      <section class="analytics-panel">
        <header>
          <h2>Comenzi pe zile</h2>
          <p>Create vs plătite</p>
        </header>
        <%= column_chart [
              { name: 'Create', data: charts[:orders_by_day] },
              { name: 'Plătite', data: charts[:paid_orders_by_day] }
            ],
            height: '300px',
            colors: ['#64748b', '#16a34a'],
            library: {
              scales: {
                y: { beginAtZero: true }
              }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-6">
      <section class="analytics-panel">
        <header>
          <h2>Venit pe zile</h2>
          <p>Estimare din iteme comenzi plătite</p>
        </header>
        <%= area_chart charts[:revenue_by_day],
            height: '300px',
            colors: ['#f59e0b'],
            library: {
              scales: {
                y: { beginAtZero: true }
              },
              plugins: {
                legend: { display: false }
              }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-3">
      <section class="analytics-panel">
        <header>
          <h2>Tip utilizator</h2>
        </header>
        <%= pie_chart breakdowns[:registered_vs_guest],
            donut: true,
            height: '260px',
            colors: ['#0f172a', '#94a3b8'] %>
      </section>
    </div>

    <div class="col-12 col-lg-3">
      <section class="analytics-panel">
        <header>
          <h2>Dispozitive</h2>
        </header>
        <%= pie_chart breakdowns[:devices],
            donut: true,
            height: '260px',
            colors: ['#0f172a', '#334155', '#64748b', '#94a3b8', '#cbd5e1'] %>
      </section>
    </div>

    <div class="col-12 col-lg-3">
      <section class="analytics-panel">
        <header>
          <h2>Browsere</h2>
        </header>
        <%= pie_chart breakdowns[:browsers],
            donut: true,
            height: '260px',
            colors: ['#111827', '#374151', '#6b7280', '#9ca3af', '#d1d5db', '#e5e7eb'] %>
      </section>
    </div>

    <div class="col-12 col-lg-3">
      <section class="analytics-panel">
        <header>
          <h2>Sisteme de operare</h2>
        </header>
        <%= pie_chart breakdowns[:operating_systems],
            donut: true,
            height: '260px',
            colors: ['#1e293b', '#475569', '#64748b', '#94a3b8', '#cbd5e1', '#e2e8f0'] %>
      </section>
    </div>

    <div class="col-12 col-lg-6">
      <section class="analytics-panel">
        <header>
          <h2>Activitate pe ore (azi)</h2>
        </header>
        <%= column_chart charts[:hourly_visits_today],
            height: '280px',
            colors: ['#0f766e'],
            library: {
              scales: {
                y: { beginAtZero: true }
              },
              plugins: {
                legend: { display: false }
              }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-6">
      <section class="analytics-panel">
        <header>
          <h2>Activitate pe zilele săptămânii</h2>
        </header>
        <%= bar_chart charts[:visits_by_weekday],
            height: '280px',
            colors: ['#1d4ed8'],
            library: {
              indexAxis: 'y',
              scales: {
                x: { beginAtZero: true }
              },
              plugins: {
                legend: { display: false }
              }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <section class="analytics-panel">
        <header>
          <h2>Status comenzi</h2>
        </header>
        <%= pie_chart charts[:status_split],
            donut: true,
            height: '280px',
            colors: ['#64748b', '#0ea5e9', '#f59e0b', '#16a34a', '#dc2626', '#7c3aed', '#94a3b8'] %>
      </section>
    </div>

    <div class="col-12 col-lg-8">
      <section class="analytics-panel analytics-panel--table">
        <header>
          <h2>Top produse vândute</h2>
          <p>După venit în perioada selectată</p>
        </header>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Produs</th>
                <th class="text-end">Cantitate</th>
                <th class="text-end">Venit</th>
              </tr>
            </thead>
            <tbody>
              <% if tables[:top_products].any? %>
                <% tables[:top_products].each do |row| %>
                  <tr>
                    <td><strong><%= row[:name] %></strong></td>
                    <td class="text-end"><%= number_with_precision(row[:quantity], precision: (row[:quantity] % 1.0).zero? ? 0 : 2) %></td>
                    <td class="text-end"><%= format_money.call(row[:revenue_cents], 0) %></td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">Nu există produse vândute în intervalul selectat.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <section class="analytics-panel analytics-panel--table">
        <header>
          <h2>Top pagini de intrare</h2>
        </header>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Pagină</th>
                <th class="text-end">Vizite</th>
              </tr>
            </thead>
            <tbody>
              <% if tables[:landing_pages].any? %>
                <% tables[:landing_pages].each do |page, count| %>
                  <tr>
                    <td class="text-truncate" style="max-width: 360px;"><%= page %></td>
                    <td class="text-end"><%= number_with_delimiter(count) %></td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="2" class="text-center text-muted py-4">Nu există date disponibile.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <section class="analytics-panel analytics-panel--table">
        <header>
          <h2>Top surse externe</h2>
        </header>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Sursă</th>
                <th class="text-end">Vizite</th>
              </tr>
            </thead>
            <tbody>
              <% if tables[:top_referrers].any? %>
                <% tables[:top_referrers].each do |referrer, count| %>
                  <tr>
                    <td class="text-truncate" style="max-width: 360px;"><%= referrer %></td>
                    <td class="text-end"><%= number_with_delimiter(count) %></td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="2" class="text-center text-muted py-4">Nu există date disponibile.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <section class="analytics-panel">
        <header>
          <h2>Canale principale</h2>
          <p>Top domenii de referință</p>
        </header>
        <%= bar_chart tables[:top_sources],
            height: '320px',
            colors: ['#475569'],
            library: {
              indexAxis: 'y',
              scales: { x: { beginAtZero: true } },
              plugins: { legend: { display: false } }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <section class="analytics-panel">
        <header>
          <h2>Top țări</h2>
        </header>
        <%= bar_chart breakdowns[:countries],
            height: '320px',
            colors: ['#0f172a'],
            library: {
              indexAxis: 'y',
              scales: { x: { beginAtZero: true } },
              plugins: { legend: { display: false } }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <section class="analytics-panel">
        <header>
          <h2>Top regiuni</h2>
        </header>
        <%= bar_chart breakdowns[:regions],
            height: '320px',
            colors: ['#334155'],
            library: {
              indexAxis: 'y',
              scales: { x: { beginAtZero: true } },
              plugins: { legend: { display: false } }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <section class="analytics-panel">
        <header>
          <h2>Top orașe</h2>
        </header>
        <%= bar_chart breakdowns[:cities],
            height: '320px',
            colors: ['#1e40af'],
            library: {
              indexAxis: 'y',
              scales: { x: { beginAtZero: true } },
              plugins: { legend: { display: false } }
            } %>
      </section>
    </div>

    <div class="col-12 col-lg-6">
      <section class="analytics-panel analytics-panel--table">
        <header>
          <h2>Top evenimente</h2>
        </header>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Eveniment</th>
                <th class="text-end">Număr</th>
              </tr>
            </thead>
            <tbody>
              <% if tables[:top_events].any? %>
                <% tables[:top_events].each do |event_name, count| %>
                  <tr>
                    <td><code><%= event_name %></code></td>
                    <td class="text-end"><%= number_with_delimiter(count) %></td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="2" class="text-center text-muted py-4">Nu există date disponibile.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="col-12 col-lg-6">
      <section class="analytics-panel analytics-panel--table">
        <header>
          <h2>Sursă × Țară</h2>
          <p>Top 20 combinații după volum</p>
        </header>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Sursă</th>
                <th>Țară</th>
                <th class="text-end">Vizite</th>
              </tr>
            </thead>
            <tbody>
              <% if tables[:source_country_rows].any? %>
                <% tables[:source_country_rows].each do |row| %>
                  <tr>
                    <td><%= row[:source] %></td>
                    <td><%= row[:country] %></td>
                    <td class="text-end"><%= number_with_delimiter(row[:visits]) %></td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">Nu există date pentru combinația filtrată.</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <div class="analytics-page__footer">
    <span>Vizite autentificate: <strong><%= number_with_delimiter(engagement[:registered_visits]) %></strong></span>
    <span>Vizite guest: <strong><%= number_with_delimiter(engagement[:guest_visits]) %></strong></span>
    <span>Vizitatori noi: <strong><%= number_with_delimiter(engagement[:new_visitors]) %></strong></span>
    <span>Vizitatori reveniți: <strong><%= number_with_delimiter(engagement[:returning_visitors]) %></strong></span>
    <span>Țări active: <strong><%= number_with_delimiter(engagement[:active_countries]) %></strong></span>
    <span>Orașe active: <strong><%= number_with_delimiter(engagement[:active_cities]) %></strong></span>
    <span>Comenzi livrate: <strong><%= number_with_delimiter(commerce[:delivered_orders]) %></strong></span>
    <span>Comenzi anulate/refundate: <strong><%= number_with_delimiter(commerce[:canceled_orders]) %></strong></span>
    <span>Produse/comandă plătită: <strong><%= commerce[:average_items_per_paid_order] %></strong></span>
  </div>
</div>
