<div class="audit-logs-page container-fluid">
  <header class="audit-logs-page__header">
    <div>
      <h1>Jurnal de Activitate</h1>
      <p>Monitorizare operațiuni administrative, autentificare și modificări de date.</p>
    </div>
    <div class="audit-logs-page__actions">
      <%= link_to statistics_dashboard_audit_logs_path, class: 'btn btn-dark btn-sm' do %>
        <i class="fa-solid fa-chart-column me-1"></i>
        Statistici
      <% end %>
      <%= link_to export_dashboard_audit_logs_path(format: :csv, **request.query_parameters), class: 'btn btn-outline-secondary btn-sm' do %>
        <i class="fa-solid fa-file-csv me-1"></i>
        Export CSV
      <% end %>
    </div>
  </header>

  <section class="audit-panel audit-panel--filters">
    <%= form_with url: dashboard_audit_logs_path, method: :get, local: true, class: 'row g-2 align-items-end' do |f| %>
      <div class="col-12 col-md-4 col-xl-2">
        <%= f.label :user_id, 'Utilizator', class: 'form-label' %>
        <%= f.select :user_id,
            options_for_select(@users, params[:user_id]),
            { include_blank: 'Toți utilizatorii' },
            class: 'form-select form-select-sm' %>
      </div>

      <div class="col-6 col-md-4 col-xl-2">
        <%= f.label :action_filter, 'Acțiune', class: 'form-label' %>
        <%= f.select :action_filter,
            options_for_select(@actions.map { |a| [a.humanize, a] }, params[:action_filter]),
            { include_blank: 'Toate acțiunile' },
            class: 'form-select form-select-sm' %>
      </div>

      <div class="col-6 col-md-4 col-xl-2">
        <%= f.label :auditable_type, 'Resursă', class: 'form-label' %>
        <%= f.select :auditable_type,
            options_for_select(@auditable_types.map { |t| [t, t] }, params[:auditable_type]),
            { include_blank: 'Toate tipurile' },
            class: 'form-select form-select-sm' %>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <%= f.label :start_date, 'De la', class: 'form-label' %>
        <%= f.date_field :start_date, value: params[:start_date], class: 'form-control form-control-sm' %>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <%= f.label :end_date, 'Până la', class: 'form-label' %>
        <%= f.date_field :end_date, value: params[:end_date], class: 'form-control form-control-sm' %>
      </div>

      <div class="col-12 col-md-6 col-xl-2">
        <%= f.label :search, 'Căutare', class: 'form-label' %>
        <%= f.text_field :search,
            value: params[:search],
            placeholder: 'IP, email, user agent',
            class: 'form-control form-control-sm' %>
      </div>

      <div class="col-12 d-flex flex-wrap gap-2 justify-content-end">
        <%= f.submit 'Aplică filtre', class: 'btn btn-dark btn-sm' %>
        <%= link_to 'Resetează', dashboard_audit_logs_path, class: 'btn btn-outline-secondary btn-sm' %>
      </div>
    <% end %>
  </section>

  <section class="audit-metrics-grid">
    <article class="audit-metric-card">
      <span>Total rezultate</span>
      <strong><%= number_with_delimiter(@summary_total) %></strong>
      <small>după filtrele active</small>
    </article>

    <article class="audit-metric-card">
      <span>Evenimente azi</span>
      <strong><%= number_with_delimiter(@summary_today) %></strong>
      <small>în selecția curentă</small>
    </article>

    <article class="audit-metric-card">
      <span>Failed login</span>
      <strong><%= number_with_delimiter(@summary_failed_logins) %></strong>
      <small>evenimente de risc</small>
    </article>

    <article class="audit-metric-card">
      <span>Utilizatori unici</span>
      <strong><%= number_with_delimiter(@summary_unique_users) %></strong>
      <small>conturi active</small>
    </article>

    <article class="audit-metric-card">
      <span>IP-uri unice</span>
      <strong><%= number_with_delimiter(@summary_unique_ips) %></strong>
      <small>surse de trafic</small>
    </article>
  </section>

  <section class="audit-panel audit-panel--table">
    <div class="audit-panel__meta">
      <p>
        Afișare <strong><%= @pagy.from %>-<%= @pagy.to %></strong> din <strong><%= @pagy.count %></strong> înregistrări
      </p>
      <div class="audit-chip-group">
        <% @action_distribution.sort_by { |_, count| -count }.first(5).each do |action, count| %>
          <span class="audit-chip">
            <i class="fa-solid <%= audit_action_icon(action) %>"></i>
            <%= action.humanize %>
            <strong><%= count %></strong>
          </span>
        <% end %>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0 audit-logs-table">
        <thead>
          <tr>
            <th>Timp</th>
            <th>Utilizator</th>
            <th>Acțiune</th>
            <th>Resursă</th>
            <th>Sursă</th>
            <th class="text-end">Detalii</th>
          </tr>
        </thead>
        <tbody>
          <% if @audit_logs.any? %>
            <% @audit_logs.each do |log| %>
              <tr>
                <td class="text-nowrap">
                  <div class="audit-time-cell">
                    <strong><%= l(log.created_at, format: '%d %b %Y') %></strong>
                    <small><%= l(log.created_at, format: '%H:%M:%S') %></small>
                  </div>
                </td>

                <td>
                  <div class="audit-user-cell">
                    <% if log.user %>
                      <strong><%= log.user.email %></strong>
                      <% if log.user.admin? %>
                        <span class="badge rounded-pill text-bg-success-subtle text-success-emphasis">Admin</span>
                      <% end %>
                    <% else %>
                      <strong class="text-muted">System</strong>
                    <% end %>
                  </div>
                </td>

                <td>
                  <span class="badge rounded-pill text-bg-<%= audit_action_variant(log.action) %>-subtle text-<%= audit_action_variant(log.action) %>-emphasis audit-action-badge">
                    <i class="fa-solid <%= audit_action_icon(log.action) %>"></i>
                    <%= log.human_action %>
                  </span>
                </td>

                <td>
                  <% if log.auditable_type.present? %>
                    <div class="audit-resource-cell">
                      <strong><%= log.auditable_type %>#<%= log.auditable_id %></strong>
                      <small><%= log.auditable_name %></small>
                    </div>
                  <% else %>
                    <span class="text-muted">N/A</span>
                  <% end %>
                </td>

                <td>
                  <div class="audit-source-cell">
                    <code><%= log.ip_address.presence || 'N/A' %></code>
                    <small title="<%= log.user_agent %>"><%= truncate(log.user_agent.to_s, length: 72) %></small>
                  </div>
                </td>

                <td class="text-end">
                  <%= link_to dashboard_audit_log_path(log), class: 'btn btn-outline-secondary btn-sm' do %>
                    Vezi
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="6" class="text-center text-muted py-5">
                <i class="fa-solid fa-circle-info me-2"></i>
                Nu s-au găsit înregistrări pentru filtrele selectate.
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </section>

  <% if @audit_logs.any? %>
    <div class="audit-pagination">
      <%== pagy_bootstrap_nav(@pagy) %>
    </div>
  <% end %>
</div>
