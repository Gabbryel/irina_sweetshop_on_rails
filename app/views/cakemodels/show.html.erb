<% if @cakemodel.photo.present? %>
  <% content_for :meta_image, cl_image_path(@cakemodel.photo.key) %>
<% end %>
<% content_for :meta_description, @cakemodel.name %>

<% raw_description = if @cakemodel.content.respond_to?(:to_plain_text)
                       @cakemodel.content.to_plain_text
                     else
                       @cakemodel.content.to_s
                     end %>
<% description_text = raw_description.to_s.strip %>
<% price_value = @cakemodel.final_price.presence || @cakemodel.price_per_piece.presence %>
<% formatted_final_price = if price_value.present?
                             "#{number_with_precision(price_value, precision: 2, separator: ',', delimiter: '.')} lei"
                           else
                             'Preț indisponibil'
                           end %>
<% online_order_enabled = @cakemodel.available_online? && price_value.present? && price_value.to_d.positive? %>
<% components_for_display = @cakemodel.model_components.includes(:recipe).order(:id) %>
<% total_component_weight = components_for_display.sum { |component| component.weight.to_f } %>

<div class="container py-5 recipe-show">
  <section class="recipe-intro card border-0 shadow-sm mb-4">
    <div class="card-body recipe-intro-body">
      <div class="row g-4 align-items-center">
        <div class="col-xl-6">
          <div class="recipe-meta mb-3">
            <span class="badge rounded-pill text-bg-light text-dark">Categorie: <%= @category.name %></span>
            <span class="badge rounded-pill bg-info-subtle text-info-emphasis">Design: <%= @design.name %></span>
            <% if @cakemodel.available_online? %>
              <span class="badge rounded-pill bg-success-subtle text-success-emphasis">
                <i class="fa-solid fa-cart-shopping me-1"></i>Disponibil online
              </span>
            <% end %>
          </div>

          <h1 class="display-5 fw-bold text-dark mb-3"><%= @cakemodel.name %></h1>

          <div class="order-card border rounded-4 p-4 mb-3">
            <p class="small text-uppercase text-muted fw-semibold mb-1">Preț final</p>
            <p class="h2 fw-bold mb-0"><%= formatted_final_price %></p>
          </div>

          <div class="order-card border rounded-4 p-4 mb-3">
            <p class="small text-uppercase text-muted fw-semibold mb-2">Rețetă folosită</p>
            <% if components_for_display.any? %>
              <ul class="list-unstyled mb-2">
                <% components_for_display.each do |component| %>
                  <% component_weight = component.weight.to_f %>
                  <% component_precision = (component_weight % 1).zero? ? 0 : 2 %>
                  <% recipe_description = component.recipe&.content.to_s.squish %>
                  <li class="d-flex justify-content-between align-items-center py-1">
                    <div class="me-3">
                      <div><%= component.recipe&.name || 'Rețetă indisponibilă' %></div>
                      <% if recipe_description.present? %>
                        <p class="mb-0 text-muted small"><%= truncate(recipe_description, length: 180) %></p>
                      <% end %>
                    </div>
                    <span class="text-muted"><%= number_with_precision(component_weight, precision: component_precision, separator: ',', delimiter: '.') %> kg</span>
                  </li>
                <% end %>
              </ul>
              <% if total_component_weight.positive? %>
                <p class="mb-0 text-muted small">Greutate totală: <strong><%= number_with_precision(total_component_weight, precision: 2, separator: ',', delimiter: '.') %> kg</strong></p>
              <% end %>
            <% else %>
              <p class="text-muted mb-0">Modelul nu are încă rețetă atașată.</p>
            <% end %>
          </div>

          <% if online_order_enabled %>
            <div class="order-card border rounded-4 p-4">
              <%= form_with url: shop_cart_items_path, method: :post, data: { turbo: false }, class: 'row g-3 align-items-end' do |f| %>
                <div class="col-4">
                  <%= f.label :quantity, 'Cantitate', class: 'form-label small text-uppercase fw-semibold text-muted' %>
                  <%= f.number_field :quantity,
                                     name: 'cart_item[quantity]',
                                     value: 1,
                                     min: 1,
                                     step: 1,
                                     class: 'form-control form-control-lg' %>
                </div>
                <div class="col-8">
                  <%= hidden_field_tag :cakemodel_id, @cakemodel.id %>
                  <%= f.submit 'Adaugă în coș', class: 'btn btn-success btn-lg w-100 d-flex align-items-center justify-content-center gap-2' %>
                </div>
              <% end %>
              <p class="text-muted small mb-0 mt-2">Modelul poate fi comandat direct online și plătit securizat prin Stripe.</p>
            </div>
          <% elsif @cakemodel.available_online? %>
            <div class="alert alert-warning d-flex gap-3 align-items-start mb-0" role="alert">
              <i class="fa-solid fa-circle-info mt-1"></i>
              <div>Modelul este marcat pentru comandă online, dar nu are preț final valid. Contactează-ne la <a href="tel:0040755054002">0755 054 002</a>.</div>
            </div>
          <% else %>
            <div class="alert alert-info d-flex gap-3 align-items-start mb-0" role="alert">
              <i class="fa-solid fa-phone mt-1"></i>
              <div>Comanda online nu este disponibilă pentru acest model. Contactează echipa la <a href="tel:0040755054002">0755 054 002</a>.</div>
            </div>
          <% end %>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <%= link_to category_cakemodels_path(@category), class: 'btn btn-outline-dark' do %>
              <i class="fa-solid fa-arrow-left me-2"></i>Toate modelele <%= @category.name %>
            <% end %>
            <%= link_to 'tel:0040755054002', class: 'btn btn-outline-secondary' do %>
              <i class="fa-solid fa-phone me-2"></i>Comandă telefonic
            <% end %>
          </div>
        </div>

        <div class="col-xl-6">
          <figure class="recipe-media ratio ratio-1x1 rounded-4 overflow-hidden shadow-sm">
            <% if @cakemodel.photo.present? %>
              <%= cl_image_tag(@cakemodel.photo.key, alt: @cakemodel.name, fetch_format: :webp, class: 'w-100 h-100', style: 'object-fit: cover;') %>
            <% else %>
              <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                <span class="text-muted">Fără imagine</span>
              </div>
            <% end %>
          </figure>
        </div>
      </div>
    </div>
  </section>

  <% if description_text.present? %>
    <section class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4 p-lg-5">
        <h2 class="h5 mb-3">Descriere</h2>
        <div class="text-muted mb-0"><%= simple_format(description_text) %></div>
      </div>
    </section>
  <% end %>

  <%= render partial: 'partials/cakemodels/next_prev_section' %>

  <% if isUserAdmin? %>
    <section class="card border-0 shadow-sm mt-5">
      <div class="card-header bg-dark text-white py-3">
        <h2 class="h5 mb-0"><i class="fa-solid fa-tools me-2"></i>Admin Tools</h2>
      </div>
      <div class="card-body p-4">
        <%= render partial: 'partials/cakemodels/add_photos_form' %>
        <%= render partial: 'partials/cakemodels/add_recipes_form' %>
      </div>
    </section>
  <% end %>
</div>
