<div class="container py-5 shop-cart-container">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8">
      <div class="text-center mb-5">
        <span class="badge bg-light text-dark border rounded-pill px-3 py-2 mb-2">Checkout</span>
        <h1 class="fw-bold text-dark mb-2">Revizuie»ôte comanda</h1>
        <p class="text-muted mb-0">VerificƒÉ produsele selectate »ôi finalizeazƒÉ plata √Æn siguran»õƒÉ.</p>
      </div>

      <% if flash[:guest_order_number].present? %>
        <div class="alert alert-success">
          <h4 class="alert-heading">ComandƒÉ finalizatƒÉ</h4>
          <p class="mb-1">Comanda ta a fost √ÆnregistratƒÉ cu numƒÉrul <strong><%= Cart.find_by(id: flash[:guest_order_number])&.public_order_number || flash[:guest_order_number] %></strong>.</p>
          <% if flash[:guest_order_token].present? %>
            <p class="mb-0 small text-muted">Cod de referin»õƒÉ: <strong><%= flash[:guest_order_token] %></strong></p>
          <% end %>
          <hr>
          <p class="mb-2">Po»õi descƒÉrca sau printa confirmarea aici:
            <%= link_to 'DescarcƒÉ confirmare', shop_guest_confirmation_path(flash[:guest_order_number], flash[:guest_order_token]), class: 'btn btn-sm btn-outline-primary ms-2' %>
          </p>
          <p class="mb-0">DacƒÉ dore»ôti o confirmare pe email, contacteazƒÉ-ne la <a href="mailto:<%= OrderMailer::ADMIN_EMAIL %>"><%= OrderMailer::ADMIN_EMAIL %></a>.</p>
        </div>
      <% end %>

      <% if @cart.items.any? %>
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0">Produsele tale</h2>
              <span class="badge bg-success text-white"><%= pluralize(@cart.items.count, 'articol', 'articole') %></span>
            </div>

            <div class="list-group list-group-flush">
              <% @cart.items.includes(:recipe, :item_extras).each do |item| %>
                <% recipe = item.recipe %>
                <% unit_display = item.kg_buc.presence || 'buc' %>
                <% is_weight_item = unit_display.to_s.downcase == 'kg' %>
                <% item_step = is_weight_item ? 0.1 : 1 %>
                <% item_min = 1 %>
                <div class="list-group-item px-0 py-3">
                  <div class="row align-items-center g-3">
                    <div class="col-12 col-md-5">
                      <div class="d-flex align-items-center gap-3 cart-item-summary">
                        <% if recipe&.photo&.attached? %>
                          <%= link_to recipe_path(recipe), class: 'cart-item-thumb d-inline-flex overflow-hidden rounded-3' do %>
                            <%= cl_image_tag(recipe.photo.key,
                                            alt: recipe.name,
                                            width: 72,
                                            height: 72,
                                            crop: :fill,
                                            fetch_format: :webp,
                                            class: 'w-100 h-100 object-fit-cover') %>
                          <% end %>
                        <% else %>
                          <%= link_to(recipe ? recipe_path(recipe) : shop_cart_path,
                                      class: 'cart-item-thumb cart-item-thumb--placeholder d-inline-flex align-items-center justify-content-center rounded-3') do %>
                            <i class="fa-solid fa-cake-candles"></i>
                          <% end %>
                        <% end %>

                        <div class="cart-item-info">
                          <h3 class="h6 mb-1 text-dark">
                            <% if recipe %>
                              <%= link_to recipe_path(recipe), class: 'cart-item-link text-dark text-decoration-none' do %>
                                <%= recipe.name %>
                              <% end %>
                            <% else %>
                              <span class="text-dark"><%= item.name %></span>
                            <% end %>
                          </h3>
                          <% unit_label = "Pre»õ/#{unit_display}" %>
                          <p class="mb-0 text-muted small">
                            <%= unit_label %>: <strong><%= item.price.format %></strong>
                          </p>
                          <% if item.item_extras.any? %>
                            <ul class="list-unstyled mb-0 small text-muted mt-2">
                              <% item.item_extras.each do |ie| %>
                                <li class="d-flex justify-content-between">
                                  <span class="text-primary">+ <%= ie.name %></span>
                                  <span class="text-muted"><%= ie.price.format %></span>
                                </li>
                              <% end %>
                            </ul>
                          <% end %>
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-md-4">
                      <%= form_with url: shop_cart_item_path(item), method: :patch,
                                    data: { turbo: false, controller: 'cart-item' },
                                    class: 'd-flex align-items-center gap-2 m-0' do |f| %>
                        <%= f.label :quantity, 'Cantitate', class: 'visually-hidden' %>
                        <div class="input-group input-group-sm" style="max-width: 130px;">
                          <%= f.number_field :quantity,
                                            value: item.quantity,
                                            min: item_min,
                                            step: item_step,
                          class: 'form-control text-center fw-semibold',
                          data: { action: 'change->cart-item#submit' } %>
                          <span class="input-group-text"><%= unit_display %></span>
                        </div>
                      <% end %>
                    </div>
                    <div class="col-6 col-md-2 text-md-end">
                      <p class="mb-0 fw-semibold text-dark"><%= item.total.format %></p>
                    </div>
                    <div class="col-6 col-md-1 text-md-end">
                      <%= button_to '»òterge',
                                    shop_cart_item_path(item),
                                    method: :delete,
                                    data: { turbo: false, confirm: 'Sigur »ôtergi acest produs?' },
                                    class: 'btn btn-link text-danger p-0 fw-semibold' %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0 mt-3">
          <div class="card-body p-3 p-md-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h6 mb-0">Sumar platƒÉ</h2>
              <span class="text-muted small">PlatƒÉ securizatƒÉ prin Stripe</span>
            </div>

              <div class="bg-light rounded-3 p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <p class="mb-0 text-muted">Valoare totalƒÉ</p>
                  <p class="mb-0 h5 fw-bold text-dark"><%= @cart.total_money.format %></p>
              </div>
            </div>

            <% delivery_min_iso = @delivery_min_date&.iso8601 %>
            <% delivery_date_value = @cart.delivery_date&.iso8601 %>
            <% delivery_date_display = @cart.delivery_date ? I18n.l(@cart.delivery_date, format: :long) : nil %>
            <% delivery_max_iso = @delivery_max_date&.iso8601 %>
            <% selected_method = @cart.method_of_delivery.presence || 'pickup' %>
            <% selected_county = @cart.county %>
            <% pickup_only = @pickup_only.present? %>
            <% delivery_method_options = if pickup_only
                                           [['Ridicare personalƒÉ', 'pickup']]
                                         else
                                           Cart::DELIVERY_METHODS.map { |value| [value == 'delivery' ? 'Livrare' : 'Ridicare personalƒÉ', value] }
                                         end %>
            <% items_count = @cart.items.size %>

            <%= form_with url: shop_checkout_path,
                          method: :post,
                          class: 'row g-3',
                          data: { turbo: false, controller: 'delivery-options', delivery_options_method_value: selected_method, delivery_options_items_count_value: items_count } do |f| %>
              <div class="col-12">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <%= f.label :method_of_delivery, 'MetodƒÉ livrare (Livrare / Ridicare personalƒÉ)', class: 'form-label fw-semibold' %>
                    <%= f.select :method_of_delivery,
                                 options_for_select(delivery_method_options, pickup_only ? 'pickup' : selected_method),
                                 {},
                                 class: 'form-select',
                                 name: 'checkout[method_of_delivery]',
                                 data: { delivery_options_target: 'methodSelect', action: 'change->delivery-options#toggle' },
                                 disabled: pickup_only %>
                    <% if pickup_only %>
                      <small class="text-muted d-block mt-1">Metoda de livrare este setatƒÉ pe ridicare deoarece co»ôul con»õine produse disponibile doar pentru ridicare.</small>
                    <% end %>
                    <div class="text-danger small mt-2 d-none" data-delivery-options-target="warning" role="alert">
                      Pentru livrare trebuie sƒÉ comanzi cel pu»õin douƒÉ produse.
                    </div>
                  </div>
                    <% formatted_disabled_dates = (@disabled_delivery_dates || []).map do |d|
                         if d.respond_to?(:strftime)
                           d.strftime('%d.%m.%Y')
                         else
                           # assume already a date-like string (e.g. "2025-12-09") and normalise
                           parts = d.to_s.split('-')
                           if parts.size == 3
                             [parts[2], parts[1], parts[0]].join('.')
                           else
                             d.to_s
                           end
                         end
                       end %>
                    <div class="col-12 col-md-6"
                         data-controller="delivery-date"
                         data-action="scroll->delivery-date#connect"
                         data-delivery-date-disabled-dates-value="<%= formatted_disabled_dates.to_json %>"
                         data-delivery-date-min-date-value="<%= delivery_min_iso || Date.current.iso8601 %>">
                    <%= f.label :delivery_date, 'Data livrƒÉrii', class: 'form-label fw-semibold' %>
                    <%= f.date_field :delivery_date,
                                     name: 'checkout[delivery_date]',
                                     value: delivery_date_value,
                                     min: delivery_min_iso || Date.current.iso8601,
                                     class: 'form-control',
                                     id: 'checkout_delivery_date',
                                     data: { delivery_date_target: 'input' } %>
                    <small class="form-text text-muted">
                      Prima datƒÉ disponibilƒÉ este <strong><%= delivery_min_iso ? I18n.l(@delivery_min_date) : I18n.l(Date.current + 1.day) %></strong> √Æn func»õie de restric»õiile re»õetelor din co»ô. Pentru urgen»õe contacta»õi-ne telefonic.
                    </small>
                    <div class="text-danger small mt-1 d-none" data-delivery-date-target="message" aria-live="polite"></div>
                  </div>
                  <div class="col-12 col-md-6" data-delivery-options-target="countyGroup">
                    <%= f.label :county, 'Jude»õ', class: 'form-label fw-semibold' %>
                    <%= f.select :county,
                                 options_for_select([['SelecteazƒÉ jude»õul', '']] + @county_options.map { |county| [county, county] }, selected_county),
                                 {},
                                 class: 'form-select',
                                 name: 'checkout[county]',
                                 data: { delivery_options_target: 'countyField' },
                                 required: !pickup_only && selected_method == 'delivery',
                                 disabled: pickup_only %>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <%= f.label :full_name, 'Nume complet', class: 'form-label fw-semibold' %>
                <%= f.text_field :full_name,
                                  name: 'checkout[full_name]',
                                  value: @cart.customer_full_name,
                                  class: 'form-control',
                                  placeholder: 'Numele »ôi prenumele tƒÉu',
                                  required: true %>
              </div>
              <div class="col-12">
                <%= f.label :phone, 'NumƒÉr de telefon', class: 'form-label fw-semibold' %>
                <%= f.telephone_field :phone,
                                      name: 'checkout[phone]',
                                      value: @cart.customer_phone,
                                      class: 'form-control',
                                      placeholder: '07xx xxx xxx',
                                      required: true %>
              </div>
                  <div class="col-12" data-delivery-options-target="addressGroup">
                <%= f.label :delivery_address, 'AdresƒÉ de livrare', class: 'form-label fw-semibold' %>
                <%= f.text_area :delivery_address,
                                 name: 'checkout[delivery_address]',
                                 value: @cart.delivery_address,
                                 class: 'form-control',
                                 placeholder: 'StradƒÉ, numƒÉr, bloc, apartament, ora»ô',
                                 rows: 3,
                                 data: { delivery_options_target: 'addressField' },
                                     required: !pickup_only && selected_method == 'delivery',
                                     disabled: pickup_only %>
              </div>
              <div class="col-12">
                <%= f.label :email, 'Adresa de email pentru confirmare', class: 'form-label fw-semibold' %>
                <%= f.email_field :email,
                                  name: 'checkout[email]',
                                  value: nil,
                                  class: 'form-control',
                                  placeholder: 'exemplu@email.com',
                                  required: true %>
                <div class="form-check mt-2">
                  <%= check_box_tag 'checkout[no_email]', '1', false, id: 'checkout_no_email', class: 'form-check-input' %>
                  <%= label_tag 'checkout_no_email', 'FƒÉrƒÉ adresƒÉ de email', class: 'form-check-label' %>
                </div>
                <div class="mt-3 d-none" id="pickup_password_group">
                  <%= f.label :pickup_password, 'ParolƒÉ pentru ridicare', class: 'form-label fw-semibold' %>
                  <%= f.text_field :pickup_password,
                                    name: 'checkout[pickup_password]',
                                    class: 'form-control',
                                    placeholder: 'Alege o parolƒÉ pentru ridicare',
                                    autocomplete: 'off' %>
                  <small class="text-muted">Vom folosi aceastƒÉ parolƒÉ pentru a verifica ridicarea comenzii tale.</small>
                </div>
                <script>
                  document.addEventListener('DOMContentLoaded', function(){
                    var cb = document.getElementById('checkout_no_email');
                    var emailInput = document.querySelector('input[name="checkout[email]"]');
                    var pwdGroup = document.getElementById('pickup_password_group');
                    var pwdInput = document.querySelector('input[name="checkout[pickup_password]"]');
                    if(!cb || !emailInput) return;
                    cb.addEventListener('change', function(){
                      if(cb.checked){
                        emailInput.value = '';
                        emailInput.disabled = true;
                        emailInput.required = false;
                        if(pwdGroup){ pwdGroup.classList.remove('d-none'); }
                        if(pwdInput){ pwdInput.required = true; }
                      } else {
                        emailInput.disabled = false;
                        emailInput.required = true;
                        if(pwdGroup){ pwdGroup.classList.add('d-none'); }
                        if(pwdInput){
                          pwdInput.required = false;
                          pwdInput.value = '';
                        }
                      }
                    });
                  });
                </script>
              </div>
              <div class="col-12">
                <%= f.label :notes, 'Men»õiuni speciale (op»õional)', class: 'form-label fw-semibold' %>
                <%= f.text_area :notes,
                                 name: 'checkout[notes]',
                                 value: @cart.customer_notes,
                                 class: 'form-control',
                                 placeholder: 'Ex: FƒÉrƒÉ nuci sau alte op»õiuni',
                                 rows: 3 %>
              </div>
              <div class="col-12">
                <%= f.submit 'FinalizeazƒÉ comanda', class: 'btn btn-primary w-100 d-flex justify-content-center align-items-center gap-2 py-2' %>
              </div>
            <% end %>
            <p class="text-muted small mt-3 mb-0 text-center">Prin continuare e»ôti de acord cu <a href="#" class="text-decoration-none">Termenii »ôi condi»õiile</a> »ôi <a href="#" class="text-decoration-none">Politica de confiden»õialitate</a>.</p>
          </div>
        </div>
      <% else %>
        <div class="card shadow-sm border-0">
          <div class="card-body p-5 text-center">
            <div class="display-4 text-muted mb-3">üõçÔ∏è</div>
            <h2 class="h5 mb-2 text-dark">Co»ôul tƒÉu este gol</h2>
            <p class="text-muted mb-4">ExploreazƒÉ produsele »ôi adaugƒÉ-le pentru a continua comanda.</p>
            <%= link_to 'Vezi produsele', categories_path, class: 'btn btn-outline-primary btn-lg' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

